<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Descobrir Investimentos de VCs</title>
  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #0f62fe;
      --accent: #00bfa6;
      --danger: #ef4444;
      --success: #16a34a;
      --saved: #fbbf24;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(12,13,16,0.08);
      --shadow-lg: 0 8px 24px rgba(12,13,16,0.12);
      --max-width: 1400px;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;}

    body{
      font-family:'Inter', system-ui, -apple-system, sans-serif;
      background:var(--bg);
      color:#111827;
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
    }

    /* Header */
    .header{
      background:linear-gradient(90deg,#ffffff 0%, rgba(255,255,255,0.98) 100%);
      border-bottom:1px solid rgba(16,24,40,0.06);
      padding:16px 20px;
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(8px);
    }

    .header-inner{
      max-width:var(--max-width);
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      flex:1;
    }

    .logo{
      width:40px;
      height:40px;
      border-radius:8px;
      object-fit:contain;
    }

    .title-block h1{
      margin:0;
      font-size:20px;
      font-weight:700;
      color:#111827;
    }

    .title-block .subtitle{
      margin:0;
      color:var(--muted);
      font-size:14px;
    }

    .header-actions{
      display:flex;
      gap:8px;
    }

    /* Buttons */
    .btn{
      padding:10px 16px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      background:var(--card);
      box-shadow:var(--shadow);
      transition:all 0.2s ease;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .btn:hover{
      transform:translateY(-1px);
      box-shadow:var(--shadow-lg);
    }

    .btn.primary{
      background:linear-gradient(135deg,var(--primary),#0747d9);
      color:#fff;
    }

    .btn.ghost{
      background:transparent;
      border:1px solid rgba(16,24,40,0.12);
      box-shadow:none;
    }

    /* Main Container */
    .main-container{
      max-width:var(--max-width);
      margin:0 auto;
      padding:20px 20px 40px;
      display:grid;
      gap:20px;
      grid-template-columns: 1fr;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
      border:1px solid rgba(16,24,40,0.04);
    }

    /* Search Panel */
    .search-form{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .search-input-wrap{
      display:flex;
      gap:12px;
    }

    #vc_input{
      flex:1;
      padding:14px 16px;
      border-radius:10px;
      border:1px solid rgba(16,24,40,0.12);
      font-size:15px;
      background:#fafbfc;
    }

    #vc_input:focus{
      outline:none;
      border-color:var(--primary);
      background:#fff;
      box-shadow:0 0 0 3px rgba(15,98,254,0.1);
    }

    .chip{
      padding:8px 12px;
      border-radius:20px;
      background:linear-gradient(135deg,#f8fafc,#fff);
      border:1px solid rgba(15,98,254,0.12);
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      color:var(--primary);
      transition:all 0.2s ease;
    }

    .chip:hover{
      background:rgba(15,98,254,0.05);
      border-color:var(--primary);
    }

    /* Stats & Charts Grid */
    .stats-charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
      gap:20px;
    }

    .stat-item{
      text-align:center;
      padding:16px;
    }

    .stat-title{
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      margin-bottom:8px;
    }

    .stat-value{
      font-weight:700;
      font-size:32px;
      color:#111827;
    }

    .chart-container{
      padding:20px;
    }

    .chart-container h3{
      margin:0 0 16px;
      font-size:16px;
      font-weight:600;
    }

    /* Results Grid - SCROLLABLE CARDS */
    .results-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
      gap:20px;
    }

    /* Startup Card - NOVO DESIGN COM SCROLL */
    .startup-card{
      background:linear-gradient(135deg, #fff, #fbfdff);
      border-radius:var(--radius);
      border:1px solid rgba(16,24,40,0.06);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      transition:all 0.3s ease;
      box-shadow:var(--shadow);
      max-height:600px; /* ALTURA MÁXIMA */
    }

    .startup-card:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow-lg);
    }

    .startup-card.saved{
      border:2px solid var(--saved);
      background:linear-gradient(135deg, #fffbeb, #fff);
      box-shadow:0 4px 16px rgba(251,191,36,0.2);
    }

    .startup-top{
      display:flex;
      gap:16px;
      padding:20px 20px 12px;
      flex-shrink:0;
    }

    .logo-wrap{
      width:56px;
      height:56px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--primary),#0747d9);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#fff;
      font-size:18px;
      flex-shrink:0;
      box-shadow:0 4px 12px rgba(15,98,254,0.3);
    }

    .startup-card.saved .logo-wrap{
      background:linear-gradient(135deg,var(--saved),#f59e0b);
    }

    .startup-body{
      flex:1;
      min-width:0;
    }

    .startup-title{
      font-size:18px;
      font-weight:700;
      margin:0 0 8px;
      color:#111827;
    }

    .startup-desc{
      color:var(--muted);
      font-size:14px;
      margin:0 0 12px;
      line-height:1.4;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .tag{
      padding:4px 8px;
      border-radius:12px;
      font-size:12px;
      font-weight:600;
      background:rgba(15,98,254,0.08);
      color:var(--primary);
    }

    /* ÁREA SCROLLABLE DO CARD */
    .meta{
      padding:16px 20px;
      background:rgba(15,98,254,0.02);
      border-top:1px solid rgba(16,24,40,0.04);
      font-size:13px;
      overflow-y:auto; /* SCROLL AQUI */
      max-height:250px;
      flex-shrink:1;
    }

    .meta-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:8px;
      gap:8px;
    }

    .meta-label{
      color:var(--muted);
      font-weight:500;
      flex-shrink:0;
    }

    .meta-value{
      color:#374151;
      font-weight:600;
      text-align:right;
      word-break:break-word;
    }

    .investment-value{
      font-size:16px;
      font-weight:700;
      color:var(--success);
    }

    /* Card Actions - SIMPLIFICADO */
    .card-actions{
      display:flex;
      justify-content:space-between;
      padding:12px 20px;
      background:#fafbfc;
      border-top:1px solid rgba(16,24,40,0.04);
      flex-shrink:0;
    }

    .small-btn{
      padding:8px 14px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      background:#fff;
      color:var(--muted);
      border:1px solid rgba(16,24,40,0.1);
      transition:all 0.2s ease;
    }

    .small-btn:hover{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .small-btn.save-btn.saved{
      background:var(--saved);
      color:#fff;
      border-color:var(--saved);
    }

    .small-btn.primary{
      background:var(--primary);
      color:#fff;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.4);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:100;
      backdrop-filter:blur(4px);
    }

    .modal-content{
      width:90%;
      max-width:900px;
      max-height:85vh;
      background:var(--card);
      border-radius:var(--radius);
      padding:32px;
      position:relative;
      box-shadow:var(--shadow-lg);
      overflow-y:auto;
    }

    .modal .close{
      position:absolute;
      right:16px;
      top:16px;
      width:32px;
      height:32px;
      border:0;
      background:rgba(16,24,40,0.06);
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .modal .close:hover{
      background:rgba(239,68,68,0.1);
      color:var(--danger);
    }

    .details-section{
      margin-bottom:24px;
    }

    .details-section h4{
      margin:0 0 12px;
      font-size:16px;
      font-weight:700;
      color:#374151;
    }

    .details-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }

    .detail-item{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .detail-label{
      font-size:12px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
    }

    .detail-value{
      font-size:14px;
      font-weight:600;
      color:#374151;
    }

    /* Toast */
    .toast{
      position:fixed;
      right:20px;
      bottom:20px;
      background:#111827;
      color:#fff;
      padding:14px 20px;
      border-radius:var(--radius);
      z-index:70;
      box-shadow:var(--shadow-lg);
      font-weight:600;
      font-size:14px;
    }

    .toast.success{background:var(--success);}
    .toast.error{background:var(--danger);}

    .hidden{display:none !important;}

    /* Empty State */
    .empty-state{
      text-align:center;
      padding:48px 24px;
      color:var(--muted);
    }

    .empty-icon{
      font-size:48px;
      margin-bottom:16px;
    }

    @media (max-width: 768px) {
      .search-input-wrap{flex-direction:column;}
      .results-grid{grid-template-columns:1fr;}
      .stats-charts-grid{grid-template-columns:1fr;}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <img src="/static/NvidiaLogo.jpeg" alt="Logo" class="logo">
        <div class="title-block">
          <h1>Descobrir Investimentos de VCs</h1>
          <p class="subtitle">Pesquise startups investidas por VCs e gere relatórios</p>
        </div>
      </div>
      <nav class="header-actions">
        <button id="btnHistorico" class="btn ghost">📊 Analytics</button>
        <button id="btnExportCsv" class="btn ghost">📥 CSV</button>
        <button id="btnDownloadPDF" class="btn primary">📄 Relatório PDF</button>
      </nav>
    </div>
  </header>

  <main class="main-container">
    <!-- Search -->
    <section class="card">
      <form id="searchForm" autocomplete="off">
        <div class="search-input-wrap">
          <input id="vc_input" type="text" placeholder="Ex: Sequoia Capital, SoftBank" />
          <button class="btn primary" type="submit">Pesquisar</button>
          <button id="btnPesquisarProfundo" class="btn primary" type="button" style="background: linear-gradient(135deg, #7c3aed, #2563eb);">
            🔍 Deep Search
          </button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;">
          <button class="chip" type="button">Sequoia Capital</button>
          <button class="chip" type="button">a16z</button>
          <button class="chip" type="button">Kaszek</button>
          <button class="chip" type="button">Monashees</button>
          <button class="chip" type="button">SoftBank</button>
        </div>
      </form>
    </section>

    <!-- Stats & Charts -->
    <div class="stats-charts-grid">
      <div class="card">
        <div class="stat-item">
          <div class="stat-title">Startups</div>
          <div id="statTotal" class="stat-value">—</div>
        </div>
      </div>
      <div class="card">
        <div class="stat-item">
          <div class="stat-title">Total Investido</div>
          <div id="statValue" class="stat-value">—</div>
        </div>
      </div>
      <div class="card">
        <div class="stat-item">
          <div class="stat-title">VCs</div>
          <div id="statVCs" class="stat-value">—</div>
        </div>
      </div>
      <div class="card chart-container">
        <h3>Setores</h3>
        <canvas id="sectorChart" height="150"></canvas>
      </div>
      <div class="card chart-container">
        <h3>Rodadas</h3>
        <canvas id="roundChart" height="150"></canvas>
      </div>
      <div class="card chart-container">
        <h3>Timeline</h3>
        <canvas id="timelineChart" height="150"></canvas>
      </div>
    </div>

    <!-- Results -->
    <section>
      <h2 style="margin:0 0 16px;font-size:24px;">Resultados</h2>
      <div id="results" class="results-grid"></div>
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">🔍</div>
        <h3>Nenhum resultado</h3>
        <p>Faça uma busca para começar</p>
      </div>
    </section>
  </main>

  <!-- Details Modal -->
  <div id="detailsModal" class="modal hidden">
    <div class="modal-content">
      <button class="close" id="closeDetails">✕</button>
      <div id="detailsContent"></div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div id="analyticsModal" class="modal hidden">
    <div class="modal-content">
      <button class="close" id="closeAnalytics">✕</button>
      <h2>📊 Analytics do Banco de Dados</h2>
      <div id="analyticsContent"></div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    let currentResults = [];
    let savedStartups = JSON.parse(localStorage.getItem('savedStartups') || '{}');
    let sectorChartInstance, roundChartInstance, timelineChartInstance;

    // Elements
    const searchForm = document.getElementById('searchForm');
    const vcInput = document.getElementById('vc_input');
    const results = document.getElementById('results');
    const emptyState = document.getElementById('emptyState');
    const toast = document.getElementById('toast');
    const detailsModal = document.getElementById('detailsModal');
    const analyticsModal = document.getElementById('analyticsModal');

    // Event Listeners
    searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const vcs = vcInput.value.trim().split(',').map(v => v.trim()).filter(Boolean);
      if (!vcs.length) return showToast('Digite pelo menos um VC', 'error');
      await performSearch(vcs, false);
    });

    document.getElementById('btnPesquisarProfundo').addEventListener('click', async () => {
      const vcs = vcInput.value.trim().split(',').map(v => v.trim()).filter(Boolean);
      if (!vcs.length) return showToast('Digite pelo menos um VC', 'error');
      await performSearch(vcs, true);
    });

    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => vcInput.value = chip.textContent);
    });

    document.getElementById('btnHistorico').addEventListener('click', () => loadAnalytics());
    document.getElementById('btnExportCsv').addEventListener('click', () => downloadCSV());
    document.getElementById('btnDownloadPDF').addEventListener('click', () => downloadPDF());
    document.getElementById('closeDetails')?.addEventListener('click', () => hideModal(detailsModal));
    document.getElementById('closeAnalytics')?.addEventListener('click', () => hideModal(analyticsModal));

    async function performSearch(vcs, deep) {
      showLoading(true);
      try {
        const endpoint = deep ? '/pesquisar-profundo' : '/pesquisar';
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({vc_list: vcs})
        });
        const data = await res.json();
        
        if (!res.ok) {
          showToast(data.erro || 'Erro na busca', 'error');
          return;
        }

        currentResults = normalizeResults(data.resultado);
        renderResults();
        updateCharts();
        showToast(`${currentResults.length} startups encontradas!`, 'success');
      } catch (err) {
        console.error(err);
        showToast('Erro de conexão', 'error');
      } finally {
        showLoading(false);
      }
    }

    function normalizeResults(data) {
      const arr = Array.isArray(data) ? data : [data];
      return arr.map((item, i) => ({
        id: item.id || `startup-${i}`,
        nome: item.nome || item.name || 'Sem nome',
        site: item.site || item.website || '',
        setor: item.setor || item.sector || 'Não informado',
        ano_fundacao: item.ano_fundacao || item.founded_year || '',
        valor_investimento: item.valor_investimento || item.funding || 'Não informado',
        rodada: item.rodada || item.round || 'Não informada',
        data_investimento: item.data_investimento || item.date || '',
        vc_investidor: item.vc_investidor || item.vc || '',
        descricao_breve: item.descricao_breve || item.description || '',
        linkedin_fundador: item.linkedin_fundador || item.linkedin || ''
      }));
    }

    function renderResults() {
      if (!currentResults.length) {
        emptyState.classList.remove('hidden');
        results.innerHTML = '';
        return;
      }

      emptyState.classList.add('hidden');
      results.innerHTML = currentResults.map(item => createCard(item)).join('');
      
      // Attach events
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('.startup-card');
          const id = card.dataset.id;
          toggleSave(id, card);
        });
      });

      document.querySelectorAll('.details-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.closest('.startup-card').dataset.id;
          const item = currentResults.find(s => s.id === id);
          showDetails(item);
        });
      });

      document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.closest('.startup-card').dataset.id;
          const item = currentResults.find(s => s.id === id);
          downloadStartupPDF(item);
        });
      });
    }

    function createCard(item) {
      const isSaved = savedStartups[item.id];
      const initials = item.nome.split(' ').slice(0,2).map(w => w[0]).join('');
      
      return `
        <article class="startup-card ${isSaved ? 'saved' : ''}" data-id="${item.id}">
          <div class="startup-top">
            <div class="logo-wrap">${initials}</div>
            <div class="startup-body">
              <h3 class="startup-title">${escapeHtml(item.nome)}</h3>
              <p class="startup-desc">${escapeHtml(item.descricao_breve || 'Sem descrição')}</p>
              <div class="tags">
                ${item.setor !== 'Não informado' ? `<span class="tag">${escapeHtml(item.setor)}</span>` : ''}
                ${item.rodada !== 'Não informada' ? `<span class="tag">${escapeHtml(item.rodada)}</span>` : ''}
              </div>
            </div>
          </div>
          <div class="meta">
            <div class="meta-row">
              <span class="meta-label">Investimento</span>
              <span class="meta-value investment-value">${escapeHtml(item.valor_investimento)}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">Rodada</span>
              <span class="meta-value">${escapeHtml(item.rodada)}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">Data</span>
              <span class="meta-value">${escapeHtml(item.data_investimento)}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">VC</span>
              <span class="meta-value">${escapeHtml(item.vc_investidor)}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">Fundação</span>
              <span class="meta-value">${escapeHtml(item.ano_fundacao || '—')}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">Website</span>
              <span class="meta-value">${item.site ? `<a href="${escapeHtml(item.site)}" target="_blank" style="color:var(--primary)">Link</a>` : '—'}</span>
            </div>
            <div class="meta-row">
              <span class="meta-label">LinkedIn</span>
              <span class="meta-value">${item.linkedin_fundador ? `<a href="${escapeHtml(item.linkedin_fundador)}" target="_blank" style="color:var(--primary)">Perfil</a>` : '—'}</span>
            </div>
          </div>
          <div class="card-actions">
            <button class="small-btn save-btn ${isSaved ? 'saved' : ''}">
              ${isSaved ? '⭐ Salvo' : '☆ Salvar'}
            </button>
            <button class="small-btn download-btn">📥 PDF</button>
            <button class="small-btn details-btn primary">Ver mais</button>
          </div>
        </article>
      `;
    }

    function toggleSave(id, card) {
      const item = currentResults.find(s => s.id === id);
      if (savedStartups[id]) {
        delete savedStartups[id];
        card.classList.remove('saved');
        card.querySelector('.save-btn').innerHTML = '☆ Salvar';
        card.querySelector('.save-btn').classList.remove('saved');
        showToast('Removido dos favoritos', 'success');
      } else {
        savedStartups[id] = item;
        card.classList.add('saved');
        card.querySelector('.save-btn').innerHTML = '⭐ Salvo';
        card.querySelector('.save-btn').classList.add('saved');
        showToast('Salvo nos favoritos!', 'success');
      }
      localStorage.setItem('savedStartups', JSON.stringify(savedStartups));
    }

    function showDetails(item) {
      document.getElementById('detailsContent').innerHTML = `
        <h2>${escapeHtml(item.nome)}</h2>
        <p style="color:var(--muted);margin:8px 0 24px;">${escapeHtml(item.descricao_breve)}</p>
        
        <div class="details-section">
          <h4>💰 Investimento</h4>
          <div class="details-grid">
            <div class="detail-item">
              <div class="detail-label">Valor</div>
              <div class="detail-value">${escapeHtml(item.valor_investimento)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Rodada</div>
              <div class="detail-value">${escapeHtml(item.rodada)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Data</div>
              <div class="detail-value">${escapeHtml(item.data_investimento)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">VC Investidor</div>
              <div class="detail-value">${escapeHtml(item.vc_investidor)}</div>
            </div>
          </div>
        </div>

        <div class="details-section">
          <h4>🏢 Empresa</h4>
          <div class="details-grid">
            <div class="detail-item">
              <div class="detail-label">Setor</div>
              <div class="detail-value">${escapeHtml(item.setor)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Fundação</div>
              <div class="detail-value">${escapeHtml(item.ano_fundacao || '—')}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Website</div>
              <div class="detail-value">${item.site ? `<a href="${escapeHtml(item.site)}" target="_blank">${escapeHtml(item.site)}</a>` : '—'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">LinkedIn</div>
              <div class="detail-value">${item.linkedin_fundador ? `<a href="${escapeHtml(item.linkedin_fundador)}" target="_blank">Ver perfil</a>` : '—'}</div>
            </div>
          </div>
        </div>
      `;
      showModal(detailsModal);
    }

    function updateCharts() {
      const statTotal = document.getElementById('statTotal');
      const statValue = document.getElementById('statValue');
      const statVCs = document.getElementById('statVCs');

      statTotal.textContent = currentResults.length;
      statVCs.textContent = new Set(currentResults.map(s => s.vc_investidor)).size;
      
      const totalValue = currentResults.reduce((sum, s) => {
        const val = parseInvestmentValue(s.valor_investimento);
        return sum + (val || 0);
      }, 0);
      statValue.textContent = totalValue ? formatCurrency(totalValue) : '—';

      // Sector Chart
      const sectors = {};
      currentResults.forEach(s => {
        const sector = s.setor === 'Não informado' ? 'Outros' : s.setor;
        sectors[sector] = (sectors[sector] || 0) + 1;
      });

      if (sectorChartInstance) sectorChartInstance.destroy();
      sectorChartInstance = new Chart(document.getElementById('sectorChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(sectors),
          datasets: [{
            data: Object.values(sectors),
            backgroundColor: ['#0f62fe', '#00bfa6', '#8b5cf6', '#f59e0b', '#ef4444', '#10b981']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {position: 'bottom', labels: {boxWidth: 12, font: {size: 11}}}
          }
        }
      });

      // Round Chart
      const rounds = {};
      currentResults.forEach(s => {
        const round = s.rodada === 'Não informada' ? 'Outros' : s.rodada;
        rounds[round] = (rounds[round] || 0) + 1;
      });

      if (roundChartInstance) roundChartInstance.destroy();
      roundChartInstance = new Chart(document.getElementById('roundChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(rounds),
          datasets: [{
            label: 'Startups',
            data: Object.values(rounds),
            backgroundColor: '#0f62fe'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {legend: {display: false}},
          scales: {y: {beginAtZero: true, ticks: {stepSize: 1}}}
        }
      });

      // Timeline Chart
      const years = {};
      currentResults.forEach(s => {
        if (s.ano_fundacao && s.ano_fundacao !== 'Não informado') {
          const year = s.ano_fundacao;
          years[year] = (years[year] || 0) + 1;
        }
      });

      const sortedYears = Object.keys(years).sort();
      if (timelineChartInstance) timelineChartInstance.destroy();
      timelineChartInstance = new Chart(document.getElementById('timelineChart'), {
        type: 'line',
        data: {
          labels: sortedYears,
          datasets: [{
            label: 'Fundações',
            data: sortedYears.map(y => years[y]),
            borderColor: '#00bfa6',
            backgroundColor: 'rgba(0, 191, 166, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {legend: {display: false}},
          scales: {y: {beginAtZero: true, ticks: {stepSize: 1}}}
        }
      });
    }

    async function loadAnalytics() {
      try {
        const res = await fetch('/historico');
        const data = await res.json();
        
        const totalPesquisas = data.length;
        const totalStartups = data.reduce((sum, p) => sum + (Array.isArray(p.resultado) ? p.resultado.length : 0), 0);
        const pesquisasProfundas = data.filter(p => p.tipo_pesquisa === 'profunda').length;

        document.getElementById('analyticsContent').innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin:24px 0;">
            <div class="card" style="text-align:center;padding:20px;">
              <div style="font-size:40px;font-weight:700;color:#0f62fe;">${totalPesquisas}</div>
              <div style="color:var(--muted);font-size:14px;">Total de Pesquisas</div>
            </div>
            <div class="card" style="text-align:center;padding:20px;">
              <div style="font-size:40px;font-weight:700;color:#00bfa6;">${totalStartups}</div>
              <div style="color:var(--muted);font-size:14px;">Startups Descobertas</div>
            </div>
            <div class="card" style="text-align:center;padding:20px;">
              <div style="font-size:40px;font-weight:700;color:#8b5cf6;">${pesquisasProfundas}</div>
              <div style="color:var(--muted);font-size:14px;">Deep Searches</div>
            </div>
          </div>

          <div class="card" style="margin-top:20px;">
            <h3>📊 Histórico de Pesquisas</h3>
            <div style="max-height:400px;overflow-y:auto;">
              ${data.slice(0, 20).map(p => `
                <div style="padding:12px;border-bottom:1px solid rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <strong>${escapeHtml(p.vc_list)}</strong>
                    ${p.tipo_pesquisa === 'profunda' ? '<span style="background:#8b5cf6;color:white;padding:2px 8px;border-radius:8px;font-size:11px;margin-left:8px;">DEEP</span>' : ''}
                    <div style="font-size:13px;color:var(--muted);">${Array.isArray(p.resultado) ? p.resultado.length : 0} startups</div>
                  </div>
                  <button class="small-btn" onclick="loadHistoryItem(${p.id})">Carregar</button>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        showModal(analyticsModal);
      } catch (err) {
        console.error(err);
        showToast('Erro ao carregar analytics', 'error');
      }
    }

    window.loadHistoryItem = async (id) => {
      try {
        const res = await fetch('/historico');
        const data = await res.json();
        const item = data.find(h => h.id === id);
        if (item) {
          currentResults = normalizeResults(item.resultado);
          renderResults();
          updateCharts();
          hideModal(analyticsModal);
          showToast('Histórico carregado', 'success');
        }
      } catch (err) {
        showToast('Erro ao carregar', 'error');
      }
    };

    function downloadCSV() {
      if (!currentResults.length) return showToast('Nenhum dado para exportar', 'error');
      
      const headers = ['Nome', 'Site', 'Setor', 'Ano Fundação', 'Valor Investimento', 'Rodada', 'Data Investimento', 'VC Investidor', 'Descrição', 'LinkedIn'];
      const rows = currentResults.map(s => [
        s.nome, s.site, s.setor, s.ano_fundacao, s.valor_investimento,
        s.rodada, s.data_investimento, s.vc_investidor, s.descricao_breve, s.linkedin_fundador
      ]);

      const csv = [headers, ...rows].map(row => 
        row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(',')
      ).join('\n');

      const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `startups_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
      showToast('CSV exportado!', 'success');
    }

    function downloadPDF() {
      if (!currentResults.length) return showToast('Nenhum dado para exportar', 'error');
      
      const {jsPDF} = window.jspdf;
      const doc = new jsPDF();
      
      // Header
      doc.setFillColor(15, 98, 254);
      doc.rect(0, 0, 210, 35, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(24);
      doc.text('Relatório de Startups', 20, 20);
      doc.setFontSize(12);
      doc.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')}`, 20, 28);
      
      // Stats
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(14);
      let y = 50;
      
      doc.setFillColor(248, 250, 252);
      doc.rect(15, y - 5, 180, 25, 'F');
      doc.setFontSize(11);
      doc.text(`Total de Startups: ${currentResults.length}`, 20, y);
      doc.text(`VCs: ${new Set(currentResults.map(s => s.vc_investidor)).size}`, 80, y);
      
      const totalValue = currentResults.reduce((sum, s) => sum + (parseInvestmentValue(s.valor_investimento) || 0), 0);
      doc.text(`Investimento Total: ${formatCurrency(totalValue)}`, 130, y);
      
      y += 15;
      
      // Startups
      doc.setFontSize(16);
      y += 10;
      doc.text('Startups Encontradas', 20, y);
      y += 10;
      
      currentResults.forEach((startup, idx) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        
        doc.setFillColor(255, 255, 255);
        doc.setDrawColor(200, 200, 200);
        doc.rect(15, y - 5, 180, 35, 'FD');
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`${idx + 1}. ${startup.nome}`, 20, y);
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        y += 6;
        doc.text(`Setor: ${startup.setor} | Rodada: ${startup.rodada}`, 20, y);
        y += 5;
        doc.text(`Investimento: ${startup.valor_investimento} | VC: ${startup.vc_investidor}`, 20, y);
        y += 5;
        doc.text(`Fundação: ${startup.ano_fundacao || '—'} | Data Inv.: ${startup.data_investimento}`, 20, y);
        y += 5;
        
        if (startup.site) {
          doc.setTextColor(15, 98, 254);
          doc.text(`Site: ${startup.site}`, 20, y);
          doc.setTextColor(0, 0, 0);
        }
        
        y += 12;
      });
      
      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.setTextColor(150, 150, 150);
        doc.text(`Página ${i} de ${pageCount}`, 105, 290, {align: 'center'});
      }
      
      doc.save(`relatorio_startups_${new Date().toISOString().slice(0,10)}.pdf`);
      showToast('PDF gerado com sucesso!', 'success');
    }

    function downloadStartupPDF(startup) {
      const {jsPDF} = window.jspdf;
      const doc = new jsPDF();
      
      // Header com gradiente (simulado)
      doc.setFillColor(15, 98, 254);
      doc.rect(0, 0, 210, 50, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(28);
      doc.text(startup.nome, 20, 25);
      
      doc.setFontSize(14);
      doc.text(startup.setor, 20, 38);
      
      // Corpo
      doc.setTextColor(0, 0, 0);
      let y = 65;
      
      // Descrição
      doc.setFillColor(248, 250, 252);
      doc.rect(15, y - 5, 180, 30, 'F');
      doc.setFontSize(10);
      doc.text('Descrição:', 20, y);
      y += 7;
      const descLines = doc.splitTextToSize(startup.descricao_breve || 'Sem descrição disponível', 170);
      doc.text(descLines, 20, y);
      y += descLines.length * 5 + 15;
      
      // Investimento
      doc.setFillColor(236, 253, 245);
      doc.rect(15, y, 85, 40, 'F');
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('💰 Investimento', 20, y + 10);
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      doc.text(`Valor: ${startup.valor_investimento}`, 20, y + 18);
      doc.text(`Rodada: ${startup.rodada}`, 20, y + 25);
      doc.text(`Data: ${startup.data_investimento}`, 20, y + 32);
      
      // VC
      doc.setFillColor(239, 246, 255);
      doc.rect(110, y, 85, 40, 'F');
      doc.setFont(undefined, 'bold');
      doc.text('🏢 Venture Capital', 115, y + 10);
      doc.setFont(undefined, 'normal');
      doc.text(`VC: ${startup.vc_investidor}`, 115, y + 18);
      doc.text(`Fundação: ${startup.ano_fundacao || '—'}`, 115, y + 25);
      
      y += 55;
      
      // Links
      doc.setFillColor(255, 255, 255);
      doc.setDrawColor(200, 200, 200);
      doc.rect(15, y, 180, 30, 'FD');
      doc.setFontSize(10);
      doc.setFont(undefined, 'bold');
      doc.text('🔗 Links', 20, y + 10);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(15, 98, 254);
      
      if (startup.site) {
        doc.text(`Website: ${startup.site}`, 20, y + 18);
      }
      if (startup.linkedin_fundador) {
        doc.text(`LinkedIn: ${startup.linkedin_fundador}`, 20, y + 25);
      }
      
      // Footer
      doc.setTextColor(150, 150, 150);
      doc.setFontSize(9);
      doc.text(`Gerado em ${new Date().toLocaleDateString('pt-BR')} às ${new Date().toLocaleTimeString('pt-BR')}`, 105, 285, {align: 'center'});
      
      doc.save(`${startup.nome.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
      showToast(`PDF de ${startup.nome} gerado!`, 'success');
    }

    function showLoading(show) {
      let overlay = document.getElementById('loadingOverlay');
      if (show) {
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'loadingOverlay';
          overlay.style.cssText = 'position:fixed;inset:0;background:rgba(255,255,255,0.9);backdrop-filter:blur(4px);z-index:999;display:flex;align-items:center;justify-content:center;';
          overlay.innerHTML = '<div style="background:white;padding:32px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.12);font-size:18px;font-weight:700;color:#374151;">🔍 Buscando startups...</div>';
          document.body.appendChild(overlay);
        }
      } else {
        if (overlay) overlay.remove();
      }
    }

    function showModal(modal) {
      modal.classList.remove('hidden');
    }

    function hideModal(modal) {
      modal.classList.add('hidden');
    }

    function showToast(msg, type = 'success') {
      toast.textContent = msg;
      toast.className = `toast ${type}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function parseInvestmentValue(str) {
      if (!str || str === 'Não informado') return null;
      const match = String(str).match(/([\d,.]+)/);
      if (!match) return null;
      let num = parseFloat(match[1].replace(/,/g, '.'));
      if (/million|milhões?|M/i.test(str)) num *= 1000000;
      if (/billion|bilhões?|B/i.test(str)) num *= 1000000000;
      if (/thousand|mil|K/i.test(str)) num *= 1000;
      return num;
    }

    function formatCurrency(value) {
      if (value >= 1000000000) return `R$ ${(value / 1000000000).toFixed(1)}B`;
      if (value >= 1000000) return `R$ ${(value / 1000000).toFixed(1)}M`;
      return `R$ ${value.toLocaleString('pt-BR')}`;
    }

    function escapeHtml(text) {
      const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'};
      return String(text || '').replace(/[&<>"']/g, m => map[m]);
    }

    // Inicializar
    emptyState.classList.remove('hidden');
  </script>
</body>
</html>